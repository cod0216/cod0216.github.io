---
title: GitHub WebRTC란 - 이론편
date: 2025-01-25 00:00:00 +0900
categories: [Infra, WebRTC]
tags: [Project, WebRTC, Infra]
toc: true
comments: true
---

# 01. webRTC란

webRTC(web Real-Time Communication)는 웹 브라우저와 모바일 애플리케이션이 별도의 미디어 서버 없이도 실시간으로 데이터(음성, 영상, 텍스트 등)를 직접 주고받을 수 있게 해주는 오픈소스 기술 표준이다.

# 02. 핵심 특징

- P2P(peer-to-Peer) 통신
    - 데이터가 서버를 거쳐 전달되는 것이 아니라 사용자 기기 간에 직접 전달되므로 속도가 빠르고 서버 부하가 적다.
- 초저지연(Ultra-low Latency)
    - 실시간성이 핵심이므로 지연 시간이 매우 짧아 화상 통화나 실시간 스트리밍에 최적화되어 있다.
- 표준화 및 무료
    - 구글이 오픈소스화 했으며 W3C와 IETF에서 표준으로 정해져 있어 크롬, 사파리, 파이어폭스 등 대부분의 브라우저에서 무료로 사용할 수 있다.

> WebRTC는 구글이 크롬에 최초로 오픈소스 형태로 공개하며 시작한 기술이지만 오늘날 W3C와 IETF가 관리하는 국제 표준이 되었다.
> 

# 03. 동작 순서

- WebRTC 연결은 크게 `정보 교환` → `경로 탐색` → `보안 연결` → `미디어 전송`  순서로 진행된다.

1. 시그널링(Signaling) - `정보 교환`
    - 가장 먼저 두 브라우저가 서로의 미디어 사양(코덱, 해상도 등)을 협의 하는 과정
    - 이를 위해 SDP(Session Description Protocol)라는 텍스트 문서를 교환 (TLS Handshake 개념과 비슷하다.)
    - WebSocket을 통해 전달 된다.
2. ICE Candidates 수집 - `경로 탐`색
    - 상대방의 주소를 알아내는 과정
    - 각 브라우저는 자신의 공인 IP와 사설 IP주소를 수집한다.
    - STUN 서버를 통해 자신의 외부 주소를 파악한다. ← webRTC 영역
    - 수집된 주소 목록(Candidate)을 상대방에게 보낸다. ← WebSocket 영역
3. ICE 연결 및 경로 결정(ICE Connectivity)
    - 서로 교환한 주소 후보들 중 가장 연결 품질이 좋은 경로를 테스트 한다.
    - P2P 직접 연결이 막혀 있다면, TURN 서버를 거치는 우회 경로를 선택한다.
4. DTLS/SRTP 핸드쉐이크 - `보안 연결` 
    - 경로가 확정되면 데이터를 주고 받기 전 암호화 키를 교환한다.
    - 이후 암호화 되지 않는 채널로는 데이터를 전송하지 않는다.
5. 미디어 및 데이터 전송 - `미디어 전송`
    - 위 과정이 끝나면 실시간 스트리밍이 시작된다.
    - 오디오/영상 → UDP 기반의 **SRTP** 프로토콜로 지연 시간을 최소화하며 전송
    - 일반 데이터 → **SCTP** 프로토콜을 사용하는 RTCDataChannel을 통해 파일이나 텍스트를 보낸다.

# 04. STUN

### 04-01. STUN(Session Traversal Utilities for NAT) 서버

- STUN(Session Traversal Utilities for NAT) 서버는 NAT 환경에서 클라이언트가 ‘내가 외부에서 보일 때의 공인 IP와 포트가 무엇인지’를 알기 위해 사용하는 서버

### 04-02. 왜 필요한가?

- 대부분 데이터를 전송할 때 아래 그림처럼 인터넷을 이용한다.
    
  ![1](/assets/img/what-WebRTC/1.png)
    
- 클라이언트 스스로는 자신의 공인 IP와 포트를 알 수 없다.
- 그래서 STUN 서버를 이용해서 공인 IP를 알 수 있다.
- 시그널링 과정에서 서버가 보게 되는 공인 IP는 클라이언트가 서버로 나갈 때 사용한 출구 IP이고, STUN을 통해 알아낸 공인 IP는 다른 피어가 나에게 들어올 수 있는 실제 입구 IP이다.

# 05. TURN

### 05-01. TURN(Traversal Using Relays around NAT) 서버

- TURN(Traversal Using Relays around NAT) 서버는 P2P 연결이 불가능할 때, 두 클라이언트 사이에서 모든 미디어 데이터를 대신 중계해 주는 릴레이 서버

### 05-02. 왜 필요한가?

- STUN을 통해 알게된 공인 IP를 통해 클라이언트끼리 직접 연결을 할 수 있지만 방화벽, 설정으로 인한 P2P가 불가능 한 경우가 있다.
- 이런 경우 아래 그림처럼 서버(TURN)를 하나 두고 거기를 터널처럼 이용하는 방법이 있다.
    
  ![2](/assets/img/what-WebRTC/2.png)
    
- TURN 서버를 결정하는건 개발자가 결정하는 것이 아닌 ICE 알고리즘이 자동으로 결정한다
    - WebRTC에서 TURN 이 호출 되는 시점
        1. HOST candidate(로컬 IP)
        2. STUN candidate(공인 IP)
        3. TURN candidate(릴레이) ← 최후

### 05-03. TURN 서버의 보안 구조

- TURN 서버에는 기존 DTLS와 SRTP가 그대로 유지된다.
- 그래서 TURN 서버는 데이터를 전달할 뿐 내용을 해독할 수는 없다.

### 05-04. DTLS는 언제 발생되나요?

- DTLS는 시그널링과 ICE과정이 끝나고, 두 기기가 네트워크 경로를 확보한 직후
    1. 시그널링 과정 → SDP 교환
    2. ICE → IP 주소 확인
    3. **DTLS → 암호화**
    4. SRTP/SCTP → 데이터 전송 시작

### 05-05. P2P로 직접 연결이 방화벽에 의해 이용이 제한된다면 왜 TURN 서버는 이용이 가능할까?

- TURN 서버를 이용한 통신은 외부의 침입이 아닌, 정상적인 웹 서핑이나 서비스를 이용하는 것처럼 데이터를 전달할 수 있기 때문이다.
- 상대방의 IP 주소로 데이터를 직접 전달하려고 하면 방화벽에 의해 차단되는 경우가 있다.
- 하지만 상대방이 특정 서버에 접속하여 통로를 연결한다면, 해당 통로를 통해 데이터를 전달할 수 있다.
- 이 과정에서 443 포트를 사용하기 때문에, 표준 포트를 통해 올바르게 연결할 수 있다.
